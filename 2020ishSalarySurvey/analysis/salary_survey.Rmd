---
title: '2020 Salary Survey: Data Exploration'
date: "2/7/2021"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
---

**To Dos:**

* Figure out alt ways of naming the gender bin values
* Professional Development: For what PD did you use, only sel
* Work experience: Continue to look into outliers 
* salary crosstab for % writing code?
* Tools and Skills by Gender? 
* Figure out data viz options, so it is less text heavy

helpful links 

* https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#Integration_with_formattable 
* https://haozhu233.github.io/kableExtra/use_kableExtra_with_formattable.html 
* https://stackoverflow.com/questions/64065003/how-do-double-curly-brackets-work-in-dplyr
* https://www.r-bloggers.com/2019/11/tidyverse-evolutions-curly-curly-operator-and-pivoting-feat-tidytuesday-data-leaflet-visuals/

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```




```{r, message = FALSE,echo = FALSE}
# Load Packages 
#library(tidyverse)
library(formattable)
library(ggridges)
library(DescTools)
library(googlesheets4)
library(ggplot2)
library(dplyr)
library(tidyr)
library(viridis)
library(forcats)
library(ggridges)
library(pollster)
#library(kableExtra) 
```



```{r, message = FALSE, echo = FALSE }
# Download Data 
setwd("~/Documents/salary_survey/git/progdatajobspublic/2020ishSalarySurvey/analysis")



# df <- read.csv("2_7 Survey Responses  - data_clean.csv",
#                header = T, stringsAsFactors = F, na.strings = c("", "NA"))
# currently using interactive/ in browser auth 
# whoever is running this code must have access to the gsheet
url <- 'https://docs.google.com/spreadsheets/d/1Txd27HY5Fc8MTcKGM_U1mOuRIrgjJtU7w1CSJxdvC3M/edit'

df <- googlesheets4::read_sheet(url, sheet = 'data_clean_20200222') 

# source all fucntions 
source("functions/tt_function.R") 
source("functions/median_hist.R")
source("functions/mult_resp.R")
source("functions/salary_cross.R")
source("functions/cat_cross.R")
source("functions/mult_resp_cross.R")
```

```{r, message = FALSE, echo = FALSE }
# Subset to Survey Universe 

df$work_in_politics <- as.character(df$work_in_politics)

df <- df %>% 
  ## 1) Respondents were only eligible to take this survey if (1) they worked in progressive politics 
  filter(!is.na(work_in_politics), # didnt answer the question
         work_in_politics == "Yes" |
           work_in_politics == "Did but employment ended post-election") %>% 
## 2) AND if their organization, role, or team focused on data, analytics, or technology.
  filter(
    # remove people who didnt anwser the question 
    !is.na(data_40_org), 
    !is.na(data_40_team), 
    !is.na(data_40_role),
    # remove people who answered 'No' to all three questions
         data_40_org != 'No' | 
           data_40_team != 'No' |
           data_40_role != 'No')



# Salary
## TODO: Figure out how to deal with outlier salary values

# Years of Experience 
## TODO: Figure out how to deal with outlier years of experience 
df$years_worked_data[!is.na(df$years_worked_data) & 
                       df$years_worked_data >= 35
                       ] <- NA 

df$years_worked_political_data[!is.na(df$years_worked_data) & 
                       df$years_worked_political_data >= 35
                       ] <- NA 
df$years_worked_political[!is.na(df$years_worked_data) & 
                       df$years_worked_political >= 35
                       ] <- NA 


# TO DO: check if this makes sense 
# remove people who didnt complete the survey
df <- df %>% filter(status == "Complete")

```


Respondents: 

* Number of people who completed the survey: `r nrow(df[df$status == "Complete",])`

* Number of people who partially completed the survey:`r nrow(df[df$status == "Partial",])`



```{r, message = FALSE, echo = FALSE }
# Bins 

## Gender 
df <- df %>% 
  mutate(gender_bin = case_when(
    gender == "Cis man" ~ "Cis man", 
    gender == "Prefer not to answer" ~ "Prefer not to answer",
    gender != "Prefer not to answer" |
       gender != "Cis man" ~ 'Non-Cis man'
  ))

## Race 
df <- df %>% 
# select the columns we are interested in analysing 
  # and for each respondent, count the number of 'True' values
  mutate(n_resp_selected = rowSums(select(., starts_with("race.resp")), na.rm = TRUE)) %>% 
  # recode variables.
  # - if someone has selected multiple races (n_resp_selected  > 1) then we code them as multi-racial
  # - if someone didn't select any race (n_resp_selected  = 0) then we code the as 'Other/Prefer Not to Say/Missing'. Right now, we dont have information to break up this field further 
    mutate(
      race_bin = case_when(
        race.resp.white == TRUE &
          n_resp_selected  == 1 ~ 'White',
         race.resp.black == TRUE &
          n_resp_selected  == 1 ~ 'Black',
        race.resp.native_american == TRUE &
          n_resp_selected  == 1 ~ 'Native American',
         race.resp.asian == TRUE &
          n_resp_selected  == 1 ~ 'Asian or Asian American (including South Asian)',
         race.resp.native_pacific == TRUE  & 
          n_resp_selected  == 1 ~ 'Native Hawaiian or Pacific Islander',
         race.resp.latinx == TRUE & 
          n_resp_selected  == 1 ~ 'Hispanic or Latinx', 
         race.resp.middle_eastern == TRUE  & 
          n_resp_selected  == 1 ~ 'Middle Eastern',
         n_resp_selected  > 1 ~ 'Multi-racial', 
         n_resp_selected  == 0 ~ 'Other/Prefer Not to Say/Missing', 
      ))  %>%  
        # another race bin (POC/White)
      mutate(race_bin2 = case_when(
        race_bin == 'White' ~ 'White',
        race_bin ==  'Other/Prefer Not to Say/Missing' ~  'Other/Prefer Not to Say/Missing', 
         race_bin != 'White' |
          race_bin !=  'Other/Prefer Not to Say/Missing' ~ 'POC'
        )
      )
      
        


## Age 
b <- c(20, 24, 29, 34, 39, 44, 49, 54, 59, Inf)
labels <- c('20-24', '25-29', '30-34',
            '35-39', '40-44','45-49',
            '50-54', '55-59', '60+')
df$age <- 2020 - as.numeric(df$yob)
df$age_bin <- cut(df$age, breaks = b, labels = labels, ) 


## Salary 

b <- c(0, 20000, 24999,  29999, 34999, 39999, 44999, 49999, 54999, 59999, 64999, 69999, 
       74999, 79999, 84999, 89999, 94999,99999, 104999, 109999, 114999, 119999, 124999, 
       129999, 134999, 139999, 144999, 149999, 154999, 159999, 164999, 169999, 174999,
       179999, 184999, 189999, 194999, 199999, Inf)
labels <- c("Under $20,000", "$20,000 to $24,999", 	"$25,000 to $29,999", 	
            "$30,000 to $34,999", "$35,000 to $39,999", "$40,000 to $44,999", 	
            "$45,000 to $49,999", "$50,000 to $54,999", "$55,000 to $59,999", 	
            "$60,000 to $64,999", "$65,000 to $69,999", "$70,000 to $74,999",	
            "$75,000 to $79,999", "$80,000 to $84,999",	"$85,000 to $89,999",	
            "$90,000 to $94,999",	"$95,000 to $99,999", "$100,000 to $104,999",	
            "$105,000 to $109,999",	"$110,000 to $114,999",	"$115,000 to $119,999",	
            "$120,000 to $124,999",	"$125,000 to $129,999",	"$130,000 to $134,999",
            "$135,000 to $139,999",	"$140,000 to $144,999",	"$145,000 to $149,999",	
            "$150,000 to $154,999",	"$155,000 to $159,999",	"$160,000 to $164,999",	
            "$165,000 to $169,999",	"$170,000 to $174,999",	"$175,000 to $179,999",	
            "$180,000 to $184,999",	"$185,000 to $189,999","$190,000 to $194,999",
            "$195,000 to $199,999", "$200,000+")
df$compensation <- as.numeric(df$compensation)
df$compensation_bin <- cut(df$compensation, breaks = b, labels = labels) 

df$compensation_bin_numeric <- as.numeric(df$compensation_bin) # help with finding the median 

# compensation_bin to compensation_bin_numeric crosswalk 
compensation_bin_crosswalk <- unique(df[c("compensation_bin", "compensation_bin_numeric")])

```


# Respondent Charateristics 

## Demographic Information {.tabset}


### Gender 

**What is your gender identity?**


```{r, echo=FALSE}
tt(df$gender, order_prop = T)
```

### Race / Ethnicity 
**What is your race / ethnicity? Please select all that apply.**

ToDo: Break out 'Other/Prefer Not to Say/Missing' into separate categories 
```{r, message = FALSE, echo = FALSE }
tt(df$race_bin, 
   order_prop = T, 
   last_ord = "Missing"
   )
```


```{r, message = FALSE, echo = FALSE }
tt(df$race_bin2, order_prop = T)
```


### Immigration Status 
**How long have you or your family lived in the United States?**

```{r, message = FALSE, echo = FALSE }
tt(df$immigration, 
   order_prop = F, 
   lvls = c("Iâ€™m the first generation in the United States", 
            "One or more of my parents immigrated to the United States", 
            "One or more of my grandparents immigrated to the United States",
            "My family has been in the United States for 3 generations or more", 
            "None of the above",
            "Prefer not to answer"),
   last_ord = "Missing"
   )
```

### Age 
**2020 - What is your year (YYYY) of birth?**
```{r, message = FALSE, echo = FALSE }
median_hist(df$age, 
            x_label = "Age", 
            med_label = "The median age is", 
            med_label_x_cord = median(df$age, na.rm = TRUE) + 7,
            med_label_y_cord = 50, 
            color_hist = "#440154FF"
            )
# + geom_histogram(fill = c("red"))
```


```{r, message = FALSE, echo = FALSE }
tt(df$age_bin, order_prop = F)
```



### Sexuality 
**Do you consider yourself to be ...?**
```{r, message = FALSE, echo = FALSE }
tt(df$sexual_orientation,
   order_prop = T, 
   last_ord = c("Prefer not to answer", "Missing")
   )
```



### Disability 
**Do you identify as a disabled? You are considered to have a disability if you have a physical or mental impairment or medical condition that substantially limits a major life activity, or if you have a history or record of such an impairment or medical condition.**

```{r, message = FALSE, echo = FALSE }
tt(df$disabled,
   order_prop = F, 
   lvls = c("Yes, I have or previously had a disability", "No, I don't have a disability", "Other", "Prefer not to answer"))
```



### Military Status 
**Are you a member of the military or a veteran?** 
```{r, message = FALSE, echo = FALSE }
tt(df$military_status, 
   order_prop = F, 
   lvls = c("Yes, Reserve/National Guard", "Yes, Veteran", "No", "Prefer not to answer"))
```


## Education 
**What is the highest level of education that you have completed?** 
```{r, message = FALSE, echo = FALSE }
tt(df$education_level, 
   order_prop = F,
   lvls = c("High School Diploma or GED", 
            "Associate's Degree", 
            "Bachelorâ€™s Degree", 
            "Post-bachelorâ€™s Work, no Higher Degree", 
            "Masterâ€™s or Professional Degree (MA, MPP, JD, etc.)", 
            "Doctoral Degree (PhD)", 
            "Other"), 
    last_ord = c("Prefer not to answer", "Missing")
   )
```


## Geography {.tabset}

### Country 
**What country do you live in? **
```{r, message = FALSE, echo = FALSE }
tt(df$country, order_prop = T)
```




### Area 
**What's your zip code?**

TODO: Code responses coded to Census metropolitan areas
<!-- ```{r} -->

<!-- ``` -->


## Work Experience {.tabset}
### Politics & Data 
**How many years of work experience do you have in progressive politics and in data, analytics, and technology (i.e., how many years have you been a progressive data, analytics, or technology practitioner)?**
```{r, message = FALSE, echo = FALSE }
median_hist(
  df$years_worked_political_data, 
  x_label = "Years in Politics & Data", 
  med_label = "The median years of experience is", 
  med_label_x_cord = median(df$years_worked_political_data, na.rm = TRUE) + 20,
  med_label_y_cord = 50, 
  color_hist = "#932667FF")


```

### Politics, Not Data
**How many years of work experience do you have in progressive politics but not in data, analytics, and technology (i.e., exclude any years worked in data, analytics, and technology)?**

```{r, message = FALSE, echo = FALSE }
median_hist(
  df$years_worked_political, 
  x_label = "Years in Politics But Not Data", 
  med_label = "The median years of experience is",
  med_label_x_cord = median(df$years_worked_political, na.rm = TRUE) + 20,
  med_label_y_cord = 50, 
  color_hist = "#DD513AFF"
  )
            
```


### Data, Not Politics 
**How many years of work experience do you have in data, analytics, and technology but not in progressive politics (i.e., exclude any years worked in progressive politics)?**
```{r, message = FALSE, echo = FALSE }
median_hist(df$years_worked_data, 
            x_label = "Years in Data But Not Politics", 
            med_label = "The median years of experience is",
            med_label_x_cord = median(df$years_worked_data, na.rm = TRUE) + 10,
            med_label_y_cord = 50, 
            color_hist = "#FCA50AFF"
  )
```


### Total 

```{r, message = FALSE, echo = FALSE }
total_work_experience <- df %>%
  select(years_worked_political_data,
         years_worked_political, 
         years_worked_data) %>%
  mutate(sum = rowSums(.[1:3]))%>%
  filter(!is.na(sum))

median_hist(
  total_work_experience$sum, 
  x_label = "Total Years", 
  med_label = "The median years of experience is", 
  med_label_x_cord = median(total_work_experience$sum, na.rm = TRUE) + 17,
  med_label_y_cord = 50, 
  color_hist = "#BB3754FF"
  )
```

## Employment Status {.tabset}

TO DO: Combine current status + during 2020 election cycle into a data viz. Something like this: https://www.crackthecode.io/salary2017#appendix

### Current Status 
**What is your current employment status (as of January 2021)?**
```{r, message = FALSE, echo = FALSE }
mult_resp(df, "employment_status_jan_21",  order_prop = T)
```



### During 2020 election cycle 
**What was your employment status during the 2020 election cycle?**
```{r, message = FALSE, echo = FALSE }
mult_resp(df, "employment_status_cycle_20",  order_prop = T)
```


### Involvement in Data/Analytics/Tech

* Is the primary focus (>40% of resources) of your **organization** data, analytics, or technology?
* Is the primary focus (>40% of resources) of your **team** data, analytics, or technology?
* Is the primary focus (>40% of time) of your **role** data, analytics or technology?


```{r, message = FALSE, echo = FALSE }
# make a df of just the columns/values we are interested in 
tmp <- df %>%
  select(data_40_org, data_40_team, data_40_role) %>%
  filter(!is.na(data_40_org), !is.na(data_40_team),!is.na(data_40_role))

# reshape the df 
tmp$category <- row.names(tmp)
tmp2 <- reshape2::melt(tmp, id.vars = "category")


plot_data <- tmp2 %>% 
  # for each question, get percents of people who answered yes and no 
  count(variable, value) %>% 
  group_by(variable) %>%
  mutate(pct = n /sum(n)) %>% 
  # create label for bar plot 
  mutate(bar_label =  paste0(
     sprintf("%.1f%%", round(100 * pct)), " (n = ", n, ")")) %>%
  # for the "no" values make the bar_label empty string 
  mutate(bar_label= ifelse(value == "No", " ", bar_label))%>%
  # rename values in variable column so it easier to plot 
  mutate(variable = case_when(
   variable == "data_40_org" ~ "Organization", 
   variable == "data_40_team" ~ "Team", 
   variable == "data_40_role" ~ "Role"
   )
  ) %>%
  # factor columns so it follows a particular ordering
  mutate(
    variable = factor(variable,
                      levels = c("Role", "Team", "Organization")))


p <- ggplot(plot_data, aes(x = variable, y = pct, fill = value)) +
  geom_col(width = 0.7) +
  coord_flip() +
  scale_fill_viridis_d() +
  theme_bw() +
  # remove x and y axis label 
   theme(axis.title.x = element_blank(),
         axis.title.y = element_blank()
         ) +
  # make the x-axis into percents 
  scale_y_continuous(labels = scales::percent) + 
  # add labels 
  geom_text(aes(label = bar_label),
            position = position_stack(vjust = 0.5)) + 
  # edit legend: remove the key and reverse the order of the values 
  theme(legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))

p

```

```{r}
tm2 <- read.table(text="County  Group   Plan1   Plan2   Plan3   Plan4   Plan5   Total
County1 Group1  2019    597 513 5342    3220    11691
                 County2 Group1  521 182 130 1771    731 3335
                 County3 Group1  592 180 126 2448    1044    4390
                 County4 Group1  630 266 284 2298    937 4415
                 County5 Group1  708 258 171 2640    1404    5181
                 County6 Group1  443 159 71  1580    528 2781
                 County7 Group1  492 187 157 1823    900 3559
                 County8 Group1  261 101 84  1418    357 2221", header = TRUE)

 tm2 %>% 
      filter(Group == "Group1") %>% 
      select(-Total) %>% 
      gather(key = `Plan Type`, value = value, -County, -Group) %>% 
      group_by(County, Group) %>% 
      mutate(Percentage = value/sum(value)) %>% 
      ggplot(aes(x = County, y = Percentage, fill = `Plan Type`,
                 label = paste0(round(Percentage*100), "%"))) +
      geom_col(position = position_stack(), color = "black") +
      geom_text(position = position_stack(vjust = .5)) +
      coord_flip() +
      scale_y_continuous(labels = scales::percent_format()) 
 
 #+
      facet_wrap(~Group)
```


# Job Characteristics
## Organization Type 
**How would you describe the organization?**
```{r, message = FALSE, echo = FALSE }
tt(df$org_type, order_prop = T, last_ord = 'Other') 
```


## Primary Job Function 
**What is your primary job function? If in management, please indicate the primary job function of your team.** 
```{r, message = FALSE, echo = FALSE }
tt(df$job_team_function, order_prop = T, last_ord = 'Other') 
```

## Seniority {.tabset}
**How would you describe your level of seniority within the organization?**

### Overall 

```{r, message = FALSE, echo = FALSE }
tt(df$seniority_level,
   lvls = c(
     "Entry-Level",
     "Mid-Level", 
     "Senior-Level, but not Department Head", 
     "Department Head", 
     "Organization Head, President or C-Level", 
      "Other",
     "Freelance"),
   order_prop = F) 
```

### By Gender 
```{r}
cat_cross(x = df, 
  question = seniority_level, 
  cross_var = gender_bin, 
  order_by = "levels", 
  lvls = c(
     "Entry-Level",
     "Mid-Level", 
     "Senior-Level, but not Department Head", 
     "Department Head", 
     "Organization Head, President or C-Level", 
      "Other",
     "Freelance"),
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 610)` = formattable::proportion_bar(), 
        `Cis man\n(n = 259)` = formattable::proportion_bar(), 
        `Non-Cis man\n(n = 343)` = formattable::proportion_bar()), 
        align = c('l', 'r', 'r', 'r', 'r'))
```


### By Race 
```{r}
cat_cross(x = df, 
  question = seniority_level, 
  cross_var = race_bin, 
  order_by = "levels", 
  lvls = c(
     "Entry-Level",
     "Mid-Level", 
     "Senior-Level, but not Department Head", 
     "Department Head", 
     "Organization Head, President or C-Level", 
      "Other",
     "Freelance"),
  last_ord = NULL
            )
```

### By Race (Binned)
```{r}
cat_cross(x = df, 
  question = seniority_level, 
  cross_var = race_bin2, 
  order_by = "levels", 
  lvls = c(
     "Entry-Level",
     "Mid-Level", 
     "Senior-Level, but not Department Head", 
     "Department Head", 
     "Organization Head, President or C-Level", 
      "Other",
     "Freelance"),
  last_ord = NULL
            ) %>% 
  # add some nice formatting
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 610)` = formattable::proportion_bar(),
        `POC\n(n = 211)` = formattable::proportion_bar(),
        `White\n(n = 390)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r'))
```


### By Gender x Race (Binned)
```{r}
x <- df %>%
  mutate(gender_race = paste(race_bin2, gender_bin, sep = " | ")) %>%
    filter(!is.na(seniority_level),
           !is.na(gender_race),
           gender_bin != "Prefer not to answer",
           race_bin2 != "Other/Prefer Not to Say/Missing" )

cat_cross(x = x, 
  question = seniority_level, 
  cross_var = gender_race, 
  order_by = "levels", 
  lvls = c(
     "Entry-Level",
     "Mid-Level", 
     "Senior-Level, but not Department Head", 
     "Department Head", 
     "Organization Head, President or C-Level", 
      "Other",
     "Freelance"), 
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 597)` = formattable::proportion_bar(), 
        `POC | Cis man\n(n = 83)` = formattable::proportion_bar(), 
        `POC | Non-Cis man\n(n = 127)` = formattable::proportion_bar(), 
        `White | Cis man\n(n = 173)` = formattable::proportion_bar(), 
        `White | Non-Cis man\n(n = 214)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r', 'r'))

```


## Management {.tabset}
**How many staffers do you manage? Please include everyone who reports "up the chain" to you, both directly or through layer(s) of management.**

### Overall 
```{r, message = FALSE, echo = FALSE }
tt(df$num_staffers, order_prop = F, 
   lvls = c(
     "0 staffers",
     "1-4 staffers", 
     "5-9 staffers",
     "10-14 staffers", 
     "More than 15 staffers"))
```

### By Gender 

```{r, message = FALSE, echo = FALSE }

cat_cross(x = df, 
  question = num_staffers, 
  cross_var = gender_bin, 
  order_by = "levels", 
  lvls = c(
     "0 staffers",
     "1-4 staffers", 
     "5-9 staffers",
     "10-14 staffers", 
     "More than 15 staffers"), 
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 610)` = formattable::proportion_bar(), 
        `Cis man\n(n = 259)` = formattable::proportion_bar(), 
        `Non-Cis man\n(n = 343)` = formattable::proportion_bar()), 
        align = c('l', 'r', 'r', 'r', 'r'))



```



### By Race 
```{r}

cat_cross(x = df, 
  question = num_staffers, 
  cross_var = race_bin, 
  order_by = "levels", 
  lvls = c(
     "0 staffers",
     "1-4 staffers", 
     "5-9 staffers",
     "10-14 staffers", 
     "More than 15 staffers"), 
  last_ord = NULL
)
  #           ) %>%
  # # add some nice formatting 
  #     rename(' ' = question) %>%
  #     formattable::formattable(list(
  #       `All\n(n = 610)` = formattable::proportion_bar(), 
  #       `POC\n(n = 211)` = formattable::proportion_bar(), 
  #       `White\n(n = 390)` = formattable::proportion_bar()), 
  #       align = c('l', 'r', 'r', 'r', 'r'))

```

### By Race (Binned)
```{r}
cat_cross(x = df, 
  question = num_staffers, 
  cross_var = race_bin2, 
  order_by = "levels", 
  lvls = c(
     "0 staffers",
     "1-4 staffers", 
     "5-9 staffers",
     "10-14 staffers", 
     "More than 15 staffers"), 
  last_ord = NULL) %>%
  # add some nice formatting
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 610)` = formattable::proportion_bar(),
        `POC\n(n = 211)` = formattable::proportion_bar(),
        `White\n(n = 390)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r'))

```

### By Gender x Race (Binned)
```{r}
x <- df %>%
  mutate(gender_race = paste(race_bin2, gender_bin, sep = " | ")) %>%
    filter(!is.na(num_staffers),
           !is.na(gender_race),
           gender_bin != "Prefer not to answer",
           race_bin2 != "Other/Prefer Not to Say/Missing" )

cat_cross(x = x, 
  question = num_staffers, 
  cross_var = gender_race, 
  order_by = "levels", 
  lvls = c(
     "0 staffers",
     "1-4 staffers", 
     "5-9 staffers",
     "10-14 staffers", 
     "More than 15 staffers"), 
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 597)` = formattable::proportion_bar(), 
        `POC | Cis man\n(n = 83)` = formattable::proportion_bar(), 
        `POC | Non-Cis man\n(n = 127)` = formattable::proportion_bar(), 
        `White | Cis man\n(n = 173)` = formattable::proportion_bar(), 
        `White | Non-Cis man\n(n = 214)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r', 'r'))
```


## Time Writing Code {.tabset}
**What percentage of your time do you spend directly conducting analysis or writing code - as opposed to other work such as communicating with external partners or managing staff?** 

### Overall 
```{r, message = FALSE, echo = FALSE }
x <- df$perc_time_coding * 100
plot <- ggplot(
    as.data.frame(x[!is.na(x)]),
      aes(
        x = x[!is.na(x)])) +
      geom_bar(stat = "count") +
      xlab("% of Time Conducting Analysis or Writing Code") +
      ylab("Count") + theme_bw()

plot

```

### By Seniority

```{r, message = FALSE, echo = FALSE }
tmp <- df[which(!is.na(df$perc_time_coding) &
                  !is.na(df$seniority_level)),]
tmp <- df %>%
  filter(!is.na(seniority_level) & !is.na(perc_time_coding)) %>%
  # order seniority by most to least senior 
  mutate(seniority_level = factor(seniority_level,
                                  levels = c("Other",
                                             "Freelance",
                                             "Entry-Level",
                                             "Mid-Level",
                                             "Senior-Level, but not Department Head",
                                             "Department Head",
                                             "Organization Head, President or C-Level"))) %>%
  # get Ns for people in each seniority bucket 
  group_by(seniority_level) %>% 
  mutate(seniority_level_n = n())  %>% 
  ungroup() %>% 
  # Add n-size to seniority_level label 
  mutate(seniority_level_label = paste0(seniority_level, " (N = ", seniority_level_n, ")")) %>%
  # factor the label column based on the previous ordering by seniority type 
  mutate(seniority_level_label = factor(seniority_level_label,
                                        levels = 
                                        unique(seniority_level_label[order(seniority_level)]),
                                  ordered = TRUE))

# plot the density plot
ggplot(tmp, aes(x = perc_time_coding * 100,
           y = seniority_level_label)) +
  geom_density_ridges(rel_min_height = 0.01) +
 labs(x = "% of Time Conducting Analysis or Writing Code",
      y = " ") + 
  theme_ridges() + 
  theme(axis.text = element_text(size = 10), 
        axis.title = element_text(size = 10)) 




```

### By Job Type 

```{r, message = FALSE, echo = FALSE }
tmp <- df %>%
  filter(!is.na(job_team_function) & !is.na(perc_time_coding)) %>%
  # calculate n-size for graph 
  group_by(job_team_function) %>% 
  mutate(job_team_n = n())  %>% 
  ungroup() %>% 
  # Add n-size to seniority_level label 
  mutate(job_team_label = paste0(job_team_function, " (N = ", job_team_n, ")")) %>%
  # factor the label column in alphabetical order
  mutate(job_team_label = factor(job_team_label,
                                        levels = 
                                        unique(job_team_label[order(job_team_label, decreasing = TRUE)]),
                                  ordered = TRUE))

# plot the density plot
ggplot(tmp, aes(x = perc_time_coding * 100,
           y = job_team_label)) +
  geom_density_ridges(rel_min_height = 0.01) +
 labs(x = "% of Time Conducting Analysis or Writing Code",
      y = " ") + 
  theme_ridges() + 
  theme(axis.text = element_text(size = 10), 
        axis.title = element_text(size = 10)) 

```


# Skills + Tools 

How comfortable are you with the following skills and tools?
https://stackoverflow.com/questions/43520318/how-to-use-percentage-as-label-in-stacked-bar-plot 

* Never used this before: Maybe you've heard of this tool, but you've never used it directly in or outside of work
* Introductory: You have maybe read about it or completed a tutorial, but you haven't used this in a major project
* Novice: You've used this a few times or use it at work, but you're still learning how it works
* Intermediate: You feel comfortable using this tool on your own
* Advanced: You are at home using this tool, are comfortable teaching or QCing others, or could lead a training on this topic

## Skills + Tools {.tabset}

### Tools 
#### Skill Level 
This graph displays the full distribution of responses to skill level. Responses are ordered by the proportion of respondents who rate themselves as having intermediate or advanced skills.


<!-- ```{r} -->
<!-- # make a df of just the columns/values we are interested in  -->
<!-- tmp <- df %>% -->
<!--   select(data_40_org, data_40_team, data_40_role) %>% -->
<!--   filter(!is.na(data_40_org), !is.na(data_40_team),!is.na(data_40_role)) -->

<!-- # reshape the df  -->
<!-- tmp$category <- row.names(tmp) -->
<!-- tmp2 <- reshape2::melt(tmp, id.vars = "category") -->


<!-- plot_data <- tmp2 %>%  -->
<!--   # for each question, get percents of people who answered yes and no  -->
<!--   count(variable, value) %>%  -->
<!--   group_by(variable) %>% -->
<!--   mutate(pct = n /sum(n)) %>%  -->
<!--   # create label for bar plot  -->
<!--   mutate(bar_label =  paste0( -->
<!--      sprintf("%.1f%%", round(100 * pct)), " (N = ", n, ")")) %>% -->
<!--   # for the "no" values make the bar_label empty string  -->
<!--   mutate(bar_label= ifelse(value == "No", " ", bar_label))%>% -->
<!--   # rename values in variable column so it easier to plot  -->
<!--   mutate(variable = case_when( -->
<!--    variable == "data_40_org" ~ "Organization",  -->
<!--    variable == "data_40_team" ~ "Team",  -->
<!--    variable == "data_40_role" ~ "Role" -->
<!--    ) -->
<!--   ) %>% -->
<!--   # factor columns so it follows a particular ordering -->
<!--   mutate( -->
<!--     variable = factor(variable, -->
<!--                       levels = c("Role", "Team", "Organization"))) -->


<!-- p <- ggplot(plot_data, aes(x = variable, y = pct, fill = value)) + -->
<!--   geom_col(width = 0.7) + -->
<!--   coord_flip() + -->
<!--   scale_fill_viridis_d() + -->
<!--   theme_bw() + -->
<!--   # remove x and y axis label  -->
<!--    theme(axis.title.x = element_blank(), -->
<!--          axis.title.y = element_blank() -->
<!--          ) + -->
<!--   # make the x-axis into percents  -->
<!--   scale_y_continuous(labels = scales::percent) +  -->
<!--   # add labels  -->
<!--   geom_text(aes(label = bar_label), -->
<!--             position = position_stack(vjust = 0.5)) +  -->
<!--   # edit legend: remove the key and reverse the order of the values  -->
<!--   theme(legend.title = element_blank()) +  -->
<!--   guides(fill = guide_legend(reverse = TRUE)) -->

<!-- p -->
<!-- ``` -->


### Learn 
**How did you learn the skills and tools you use weekly for your job? Please pick your top two options** 

```{r, message = FALSE, echo = FALSE }
mult_resp(df, "skills_learning_method", order_prop = T)
```


## Skills {.tabset}
**Which of the following items have you personally done in the last year? Please select all that apply.**

### Technical 

TODO: Add in "none of the above" responses. 
```{r, message = FALSE, echo = FALSE }
# technical 

tmp <- select(
  df, 
  projects_done_management.resp.universes, 
  projects_done_management.resp.rct, 
  projects_done_management.resp.pipelines, 
  projects_done_management.resp.stats_analysis, 
  projects_done_management.resp.software_dev_manage, 
  projects_done_management.resp.polling, 
  projects_done_management.resp.build_model, 
  projects_done_management.resp.software_dev, 
  projects_done_management.resp.dev_ops
              )

## missing none of the above 

mult_resp(tmp, "projects_done_management", order_prop = T)

```



### Management
TODO: Add in "none of the above" responses. 

```{r, message = FALSE, echo = FALSE }
tmp <- select(
  df, 
  projects_done_management.resp.review_work,
  projects_done_management.resp.present_results,
  projects_done_management.resp.pitch_project,
  projects_done_management.resp.coordinate_orgs,
  projects_done_management.resp.hire_fire,
  projects_done_management.resp.create_prof_dev_plan
              )

## missing none of the above 
mult_resp(tmp, "projects_done_management", order_prop = T)
```

### Free Text 
**Please describe any other major components of your work.**

# Salary Overview 

**In US Dollars, what is your total expected annual pre-tax income, including bonuses or commissions? This figure may be salaried or unsalaried.**

```{r, message = FALSE, echo = FALSE }
df1 <- df %>%
  mutate( variable = "All") 

salary_cross(x = df1, 
             variable = variable,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "n") 

rm(df1)
```


## Salary Distribution {.tabset}

```{r, message = FALSE, echo = FALSE }
tt(df$compensation_bin)
```

## Benefits 

**Which of the following benefits are you personally eligible for? Select all that apply.**
```{r, message = FALSE, echo = FALSE }
mult_resp(df, "benefits.resp", order_prop = T)
```

## Negotiation {.tabset}

### Try Negotiate {.tabset}
**During your last job offer or performance review, did you try to negotiate your salary?**

#### Overall 
```{r, message = FALSE, echo = FALSE }
tt(df$negotiate_yesno, 
   lvls = c("Yes", "No", "Not applicable (union, freelancer, etc.)"),
   last_ord = "Missing")
```

#### By Gender 

```{r, message = FALSE, echo = FALSE }
cat_cross(x = df, 
  question = negotiate_yesno, 
  cross_var = gender_bin, 
  order_by = "levels", 
  lvls = c("Yes", "No", "Not applicable (union, freelancer, etc.)"), 
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 597)` = formattable::proportion_bar(), 
        `Cis man\n(n = 256)` = formattable::proportion_bar(), 
        `Non-Cis man\n(n = 341)` = formattable::proportion_bar()), 
        align = c('l', 'r', 'r', 'r'))
```



#### By Race (Binned)
```{r, message = FALSE, echo = FALSE }
cat_cross(x = df, 
  question = negotiate_yesno, 
  cross_var = race_bin2, 
  order_by = "levels", 
  lvls = c("Yes", "No", "Not applicable (union, freelancer, etc.)"), 
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 597)` = formattable::proportion_bar(), 
        `POC\n(n = 210)` = formattable::proportion_bar(), 
        `White\n(n = 387)` = formattable::proportion_bar()), 
        align = c('l', 'r', 'r', 'r', 'r'))

```

#### By Gender x Race (Binned)

```{r, message = FALSE, echo = FALSE }
# do some data munging before entering df into function argument
x <- df %>%
  mutate(gender_race = paste(race_bin2, gender_bin, sep = " | ")) %>%
    filter(!is.na(negotiate_yesno),
           !is.na(gender_race),
           gender_bin != "Prefer not to answer",
           race_bin2 != "Other/Prefer Not to Say/Missing" )

cat_cross(x = x, 
  question = negotiate_yesno, 
  cross_var = gender_race, 
  order_by = "levels", 
  lvls = c("Yes", "No", "Not applicable (union, freelancer, etc.)"), 
  last_ord = NULL
            ) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 597)` = formattable::proportion_bar(), 
        `POC | Cis man\n(n = 83)` = formattable::proportion_bar(), 
        `POC | Non-Cis man\n(n = 127)` = formattable::proportion_bar(), 
        `White | Cis man\n(n = 173)` = formattable::proportion_bar(), 
        `White | Non-Cis man\n(n = 214)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r', 'r'))

```


### Negotiation Successful {.tabset}
**Was your negotiation successful? Please select all that apply.** [only asked to respondents who attempted a negotiation]

#### Overall 
```{r, message = FALSE, echo = FALSE }

mult_resp(df %>% filter(negotiate_yesno =="Yes"),
          "negotiation_result")
```


#### By Gender 

```{r, message = FALSE, echo = FALSE }
mult_resp_cross(
  x = df %>% # remove people who didn't answer yes to the previous question
  filter(negotiate_yesno =="Yes"),
  question_prefix = "negotiation_result", 
  cross_var = gender_bin
  )  %>%
  # add some nice formatting 
      rename(' ' = var) %>%
      formattable::formattable(list(
        `All\n(n = 219)` = formattable::proportion_bar(), 
        `Cis man\n(n = 92)` = formattable::proportion_bar(), 
        `Non-Cis man\n(n = 124)` = formattable::proportion_bar(), 
        `Prefer not to answer\n(n = 3)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r'))
```

#### By Race
```{r, message = FALSE, echo = FALSE }
mult_resp_cross(
  x = df %>% # remove people who didn't answer yes to the previous question
  filter(negotiate_yesno =="Yes"),
  question_prefix = "negotiation_result", 
  cross_var = race_bin2
  )  %>%
  # add some nice formatting 
      rename(' ' = var) %>%
      formattable::formattable(list(
        `All\n(n = 219)` = formattable::proportion_bar(), 
        `Other/Prefer Not to Say/Missing\n(n = 3)` = formattable::proportion_bar(), 
        `POC\n(n = 83)` = formattable::proportion_bar(), 
        `White\n(n = 133)` = formattable::proportion_bar()),
        align = c('l', 'r', 'r', 'r', 'r'))
```


## Professional Development {.tabset}

### Opportunity
**Does your employer offer any career development opportunities?**
```{r, message = FALSE, echo = FALSE }
tt(
  x = df$prof_dev_yesno, 
  order_prop = F, 
  lvls = c("Yes", "Yes, but I am not eligible", "No", "Not sure")
  )
```


### Available 
**What types of employer-funded professional development opportunities are available to you? Please select all that apply.** [only asked to respondents who are offered career development opportunities]
```{r, message = FALSE, echo = FALSE }
mult_resp(df %>% filter(prof_dev_yesno == "Yes"),
          "prof_dev_available",
          order_prop = T)
```


### Used 
**Which of these professional development opportunities have you used? Please select all that apply.** [only asked to respondents who are offered career development opportunities]

TODO: Add logic to valid response. People should only select values that they selected in prof_dev_available. 

```{r, message = FALSE, echo = FALSE }
mult_resp(df %>% filter(prof_dev_yesno == "Yes"),
          "prof_dev_used", 
          order_prop = T)
```


### Free Text 
**Thinking about your career path and focus, which one specific skill or tool do you most want to learn?**
TODO

# Salary Crosstabs 

## Respondent Characteristics {.tabset}

### Gender
```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = gender,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "levels",
             lvls = c("Different gender identity, prefer to specify",
                      "Cis woman",
                      "Trans woman",
                      "Trans man",
                      "Prefer not to answer",
                      "Cis man",
                      "Gender non-binary or non-conforming")) 

```

```{r, message = FALSE, echo = FALSE }

df2 <- df %>%
  select(gender_bin, compensation, years_worked_political_data, years_worked_political, years_worked_data) %>%
  filter(
    !is.na(gender_bin),
    !is.na( compensation),
    !is.na(years_worked_political_data), 
    !is.na(years_worked_political), 
    !is.na(years_worked_data),
    gender_bin != 'Prefer not to answer') %>%
  transmute(
   variable = gender_bin,
    salary_total =  compensation,
    work_pol_data = years_worked_political_data,
    work_pol_nodata = years_worked_political,
    work_nopol_data = years_worked_data) %>%
  mutate(totalyears = rowSums(.[3:5])) %>%
  arrange(desc(salary_total))

# rm outlier
df2 <- df2[df2$totalyears <= 35,]

## creates chart
ggplot(df2, aes(x = totalyears, y = salary_total, color = variable)) +
  geom_jitter(stat = "identity", width = 2, height = 2) +
  geom_smooth(method = "loess", se = FALSE) +
  theme_light()+
  theme(legend.title=element_blank())+
  xlab("Years of Experience")+
  ylab("Salary")

```

### Race / Ethnicity
```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = race_bin,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "n", # n, levels, alpha
             last_ord = c("Other/Prefer Not to Say/Missing")
             ) 
```

```{r, message = FALSE, echo = FALSE }

df2 <- df %>%
  select(race_bin2, compensation, years_worked_political_data, years_worked_political, years_worked_data) %>%
  filter(
    !is.na(race_bin2),
    !is.na( compensation),
    !is.na(years_worked_political_data), 
    !is.na(years_worked_political), 
    !is.na(years_worked_data), 
    race_bin2 != 'Other/Prefer Not to Say/Missing') %>%
  transmute(
    race = race_bin2,
    salary_total =  compensation,
    work_pol_data = years_worked_political_data,
    work_pol_nodata = years_worked_political,
    work_nopol_data = years_worked_data) %>%
  mutate(totalyears = rowSums(.[3:5])) %>%
  arrange(desc(salary_total))

# rm outlier
df2 <- df2[df2$totalyears <= 35,]

## creates chart
ggplot(df2, aes(x = totalyears, y = salary_total, color = race)) +
  geom_jitter(stat = "identity", width = 2, height = 2) +
  geom_smooth(method = "loess", se = FALSE) +
  theme_light()+
  theme(legend.title=element_blank())+
  xlab("Years of Experience")+
  ylab("Salary")

```


### Gender x Race / Ethnicity (Binned)

```{r, message = FALSE, echo = FALSE }

df1 <- df %>% 
  mutate(gender_race = paste(race_bin2, gender_bin, sep = " | ")) 


salary_cross(x = df1, 
             variable = gender_race,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "n", # n, levels, alpha
             last_ord = c("Other/Prefer Not to Say/Missing")
             ) 


rm(df1)



```


### Age
```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = age_bin,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "alpha", # mean, levels, alpha
             last_ord = c("Other/Prefer Not to Say/Missing")
             ) 


```



### Sexuality 
```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = sexual_orientation,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "n", # n, levels, alpha
             last_ord = c("Other/Prefer Not to Say/Missing")
             ) 

```


### Disability 
```{r, message = FALSE, echo = FALSE }
salary_cross(x = df, 
             variable = disabled,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "levels", # mean, levels, alpha
             lvls = c("Yes, I have or previously had a disability", 
                      "No, I don't have a disability", "Other"),
             last_ord = c("Prefer not to answer", "Missing")
             ) 

```

## Education 
```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = education_level,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "levels", # mean, levels, alpha
              lvls = c("High School Diploma or GED", 
                       "Associate's Degree", 
                       "Bachelorâ€™s Degree", 
                       "Post-bachelorâ€™s Work, no Higher Degree", 
                       "Masterâ€™s or Professional Degree (MA, MPP, JD, etc.)", 
                       "Doctoral Degree (PhD)", 
                       "Other"), 
    last_ord = c("Prefer not to answer", "Missing")
             ) 


```

## Work Experience 
```{r, message = FALSE, echo = FALSE }
salary_work <- df %>%
  select( compensation, years_worked_political_data, years_worked_political, years_worked_data) %>%
  filter(!is.na( compensation),
         !is.na(years_worked_political_data), 
         !is.na(years_worked_political), 
         !is.na(years_worked_data)) %>%
  transmute(
    salary_total =  compensation,
    work_pol_data = years_worked_political_data,
    work_pol_nodata = years_worked_political,
    work_nopol_data = years_worked_data) %>%
  mutate(totalyears = rowSums(.[2:4])) %>%
  arrange(desc(salary_total))

salary_work <- salary_work[salary_work$totalyears <= 35,]

## creates chart
ggplot(salary_work, aes(x = totalyears, y = salary_total)) +
  geom_jitter(stat = "identity", width = 2, height = 2) +
  geom_smooth(method = "loess") +
  theme_light()+
  xlab("Years of Experience")+
  ylab("Salary")
```


## Job Characteristics {.tabset}

### Organization 
```{r, message = FALSE, echo = FALSE }
salary_cross(x = df,
             variable = org_type,
             salary = compensation,
             salary_bin = compensation_bin, 
             order_by = "n", # n, levels, alpha
             lvls = NULL,
             last_ord = NULL)
```

### Seniority 

```{r, message = FALSE, echo = FALSE }


salary_cross(x = df, 
             variable = seniority_level,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "levels", # mean, levels, alpha
              lvls = c("Entry-Level",
                         "Mid-Level",
                         "Senior-Level, but not Department Head",
                         "Department Head",
                         "Organization Head, President or C-Level", 
                         "Other",
                         "Freelance"))

```


### Management 

```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = num_staffers,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "levels", # n, levels, alpha
             lvls = c("0 staffers",
                      "1-4 staffers", 
                      "5-9 staffers",
                      "10-14 staffers", 
                      "More than 15 staffers"))
```


### Management Binned (0 staff, 1- 4, and >=5)
```{r, message = FALSE, echo = FALSE }
salary_cross(x = df %>% mutate(
  num_staffers_bin = case_when(
    num_staffers == "0 staffers" ~ "0 staffers", 
    num_staffers == "1-4 staffers" ~ "1-4 staffers", 
    num_staffers != "0 staffers" | num_staffers != "1-4 staffers" ~ "5+ staffers"
    )
  ), 
  variable = num_staffers_bin,
  salary = compensation, 
  salary_bin = compensation_bin, 
  order_by = "levels", # mean, levels, alpha
  lvls = c("0 staffers",
           "1-4 staffers", 
           "5+ staffers"))

```


### Primary Job Function 


```{r, message = FALSE, echo = FALSE }

salary_cross(x = df, 
             variable = job_team_function,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "n") 


```

### Time Writing Code 

```{r}
salary_cross(x = df, 
             variable = perc_time_coding,
             salary = compensation, 
             salary_bin = compensation_bin, 
             order_by = "alpha") 

```

```{r}
## creates chart
ggplot(df, aes(x = perc_time_coding * 100, y = compensation)) +
  geom_jitter(stat = "identity", width = 2, height = 2) +
  geom_smooth(method = "loess") +
  theme_light()+
  xlab("Percent of Time Writing Code")+
  ylab("Salary") 
```


#### Take into account Managing 
```{r}
## creates chart
ggplot(df, aes(x = perc_time_coding * 100, y = compensation)) +
  geom_jitter(stat = "identity", width = 2, height = 2) +
  geom_smooth(method = "loess") +
  theme_light()+
  xlab("Percent of Time Writing Code")+
  ylab("Salary") + 
  facet_wrap(~ num_staffers) 
```


## Tools + Skills {.tabset}
Learn (on the job etc) x salary medians? 


# Career Plans {.tabset}

## Next Steps 

**Which of the following most accurately describes the next step you would like to take to advance your career? Please select all that apply.**
```{r, message = FALSE, echo = FALSE }
mult_resp(df, "next_career_step",  order_prop = T)
```

## Plans to Leave

**Are you planning to leave your organization within the next year?**
```{r, message = FALSE, echo = FALSE }
tt(df$leaving_org,
   order_prop =  F, 
   lvls = c("I plan to actively look for new opportunities",
            "I might leave, but Iâ€™m not sure", 
            "Iâ€™m not planning to leave", 
            "My current job / contract ends within the next 12 months", 
            "I am currently unemployed"
            )
   )
```

## Plans to Leave Crosstabs {.tabset}
### By Gender 

```{r}
cat_cross(x = df, 
          question = leaving_org, 
          cross_var = gender_bin, 
          order_by = "levels", 
          lvls = c("I plan to actively look for new opportunities",
            "I might leave, but Iâ€™m not sure", 
            "Iâ€™m not planning to leave", 
            "My current job / contract ends within the next 12 months", 
            "I am currently unemployed"), 
          last_ord = NULL) %>%
  # add some nice formatting 
      rename(' ' = question) %>%
      formattable::formattable(list(
        `All\n(n = 610)` = formattable::proportion_bar(), 
        `Cis man\n(n = 259)` = formattable::proportion_bar(), 
        `Non-Cis man\n(n = 343)` = formattable::proportion_bar()), 
        align = c('l', 'r', 'r', 'r', 'r'))
```

### By Race 
```{r}
cat_cross(x = df, 
          question = leaving_org, 
          cross_var = race_bin, 
          order_by = "levels", 
          lvls = c("I plan to actively look for new opportunities",
            "I might leave, but Iâ€™m not sure", 
            "Iâ€™m not planning to leave", 
            "My current job / contract ends within the next 12 months", 
            "I am currently unemployed"), 
          last_ord = NULL)
# %>%
#   # add some nice formatting 
#       rename(' ' = question) %>%
#       formattable::formattable(list(
#         `All\n(n = 610)` = formattable::proportion_bar(), 
#         `Cis man\n(n = 259)` = formattable::proportion_bar(), 
#         `Non-Cis man\n(n = 343)` = formattable::proportion_bar()), 
#         align = c('l', 'r', 'r', 'r', 'r'))
```
### By Race Bin 
```{r}
cat_cross(x = df, 
          question = leaving_org, 
          cross_var = race_bin2, 
          order_by = "levels", 
          lvls = c("I plan to actively look for new opportunities",
            "I might leave, but Iâ€™m not sure", 
            "Iâ€™m not planning to leave", 
            "My current job / contract ends within the next 12 months", 
            "I am currently unemployed"), 
          last_ord = NULL)
```


### By Gender x Race 

```{r}

x <- df %>%
  mutate(gender_race = paste(race_bin2, gender_bin, sep = " | ")) %>%
    filter(!is.na(num_staffers),
           !is.na(gender_race),
           gender_bin != "Prefer not to answer",
           race_bin2 != "Other/Prefer Not to Say/Missing" )

cat_cross(x = x, 
          question = leaving_org, 
          cross_var = gender_race, 
          order_by = "levels", 
          lvls = c("I plan to actively look for new opportunities",
            "I might leave, but Iâ€™m not sure", 
            "Iâ€™m not planning to leave", 
            "My current job / contract ends within the next 12 months", 
            "I am currently unemployed"), 
          last_ord = NULL)
```


## Why leaving 
**If you were to leave the progressive/Democratic data space in the next year, what would lead to that decision? Please select your top two reasons.**
```{r, message = FALSE, echo = FALSE }
mult_resp(df, "leaving_space", order_prop =  T)
```

## Expect to be in one year
**Where do you want or expect to be working a year from now? Select all that apply. ** [only asked to respondents who are either looking for new opportunities, might leave, on a job / contract that ends within the next 12 months, or currently unemployed]
```{r, message = FALSE, echo = FALSE }
mult_resp(df, "role_next_year", order_prop =  T)
```


# Covid 

## Additional Benefits
**Regardless of whether you were eligible, did your employer offer any additional benefits due to the COVID-19 pandemic?**
```{r, message = FALSE, echo = FALSE }
tt(df$covid_benefits_yesno, 
   order_prop = F, 
   lvls = c("Yes", "No", "Unsure"))
```

## Benefits Offered 
**What sort of benefits were offered/provided? Please select all that apply.** [only asked to respondents whose organizations offered any additional benefits due to the COVID-19 pandemic]
```{r, message = FALSE, echo = FALSE }
mult_resp(df %>% filter(covid_benefits_yesno == "Yes"),
          "covid_benefits_specific", order_prop = T)
```

## Free Text 
**Please briefly describe how your organization handled the COVID-19 pandemic to make things easier for staff. **

TODO

# Union {.tabset}

## Is Unionized? 
**Is your organization unionized or does it have one or more recognized bargaining units?**
```{r, message = FALSE, echo = FALSE }
tt(df$is_unionized, lvls = c("Yes", "No", "Unsure"))
```

## Union Member? 
**Are you a member of the union/bargaining unit?** [only asked to respondents whose organization is unionized or has one or more recognized bargaining units]
```{r, message = FALSE, echo = FALSE }
tt(df$bargaining_unit_member[df$is_unionized == "Yes"], 
    lvls = c("Yes", "No, do not qualify for membership", "Unsure"))
```


## Date of Unionization 
**When did your organization unionize?** [only asked to respondents whose organization is unionized or has one or more recognized bargaining units]
```{r, message = FALSE, echo = FALSE }
tt(df$when_unionized[df$is_unionized == "Yes"], 
   lvls = c("Within the past two years", "In the past two to five years", "More than five years ago", "Iâ€™m not sure")
   )
```
